# Диагностический отчёт: Кнопка создания заметки не работает

## Краткое описание бага

При нажатии на кнопку "+" в левой панели рядом с "Страницы" ничего не происходит — новая заметка не создаётся.

## Корневая причина

**Статус: ТРЕБУЕТ ДОПОЛНИТЕЛЬНОЙ ДИАГНОСТИКИ**

### Анализ кода

Код, отвечающий за создание заметки, был **верифицирован и найден корректным**:

| Компонент | Файл | Строки | Статус |
|-----------|------|--------|--------|
| Кнопка "+" | `src/views/MainView.vue` | 46-54 | OK |
| Обработчик `handleCreateRootPage` | `src/views/MainView.vue` | 262-269 | OK |
| Функция `createNote` | `src/composables/useNotes.ts` | 31-44 | OK |
| API `notesApi.create` | `src/api/notes.ts` | 41-43 | OK |
| Контроллер `NoteController.createNote` | `server/.../NoteController.kt` | 38-59 | OK |
| Сервис `NoteService.createNote` | `server/.../NoteService.kt` | 34-56 | OK |
| Репозиторий `NoteRepository.create` | `server/.../NoteRepository.kt` | 28-54 | OK |

### Код обработчика (проверен):

```javascript
// src/views/MainView.vue:262-269
async function handleCreateRootPage() {
  try {
    const newNote = await createNote('Новая страница', null);
    openTab(newNote.id);
  } catch (error) {
    console.error('Не удалось создать страницу:', error);
  }
}
```

### Привязка события (проверена):

```html
<!-- src/views/MainView.vue:46-54 -->
<button
  @click="handleCreateRootPage"
  class="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded text-gray-700 dark:text-gray-300"
  title="Создать страницу"
>
  <svg class="w-4 h-4" ...>...</svg>
</button>
```

## Анализ

### История исправлений:

Баг с аналогичными симптомами был исправлен ранее:

| Дата | Описание |
|------|----------|
| 2026-02-18 | Добавлен `async/await` для `handleCreateRootPage` и `handleCreateSubpage` |
| 2026-02-20 | Верификация исправления подтверждена |

См. `specs/bugs/BUG_DIAGNOSTIC_create_new_note_doesn_t_work.md`

### Возможные причины повторного проявления бага:

#### 1. Кэширование браузера (ВЕРОЯТНО)

**Симптом:** Браузер использует старую закэшированную версию JavaScript

**Диагностика:**
- Открыть DevTools (F12) → Network → Disable cache
- Или выполнить Hard refresh (Ctrl+Shift+R / Cmd+Shift+R)

**Решение:**
- Очистить кэш браузера
- Использовать режим инкогнито для тестирования

#### 2. Сервер не запущен (ВЕРОЯТНО)

**Симптом:** API-запрос не отправляется или возвращает ошибку сети

**Диагностика:**
- Открыть DevTools → Network → Нажать кнопку "+"
- Проверить, есть ли запрос к `POST /api/notes`

**Решение:**
```bash
docker-compose up -d
```

#### 3. Сессия истекла (ВЕРОЯТНО)

**Симптом:** API-запрос возвращает 401 Unauthorized

**Диагностика:**
- Проверить Network tab → Статус ответа на `POST /api/notes`
- Проверить Console на ошибки авторизации

**Решение:**
- Перелогиниться в приложение
- Проверить, включен ли Demo режим (`DEMO_MODE_ENABLED=true`)

#### 4. Ошибка JavaScript в консоли (ВОЗМОЖНО)

**Симптом:** Другой JavaScript код вызывает ошибку, блокирующую выполнение

**Диагностика:**
- Открыть DevTools → Console
- Проверить наличие красных ошибок

**Решение:**
- Исправить выявленные ошибки

#### 5. Сборка не выполнена (ВОЗМОЖНО)

**Симптом:** Изменения кода не применены в production-сборке

**Диагностика:**
```bash
npm run build
```

**Решение:**
- Пересобрать и переразвернуть приложение

## Затронутые файлы

| Файл | Роль | Статус |
|------|------|--------|
| `src/views/MainView.vue` | Основной компонент с кнопкой "+" | ИСПРАВЛЕН |
| `src/composables/useNotes.ts` | Логика создания заметок | OK |
| `src/api/notes.ts` | API-клиент для заметок | OK |
| `src/api/client.ts` | HTTP-клиент | OK |
| `server/.../NoteController.kt` | REST-контроллер | OK |
| `server/.../NoteService.kt` | Бизнес-логика | OK |
| `server/.../NoteRepository.kt` | Работа с БД | OK |

## План исправления

### Этап 1: Диагностика runtime-окружения

1. **Проверить консоль браузера:**
   - Открыть DevTools (F12)
   - Перейти на вкладку Console
   - Нажать кнопку "+"
   - Искать ошибки (красные сообщения)

2. **Проверить Network tab:**
   - Открыть DevTools (F12)
   - Перейти на вкладку Network
   - Нажать кнопку "+"
   - Проверить:
     - Отправляется ли запрос `POST /api/notes`?
     - Какой статус ответа? (200, 401, 500?)
     - Какое тело ответа?

3. **Проверить состояние сервера:**
   ```bash
   docker-compose ps
   curl http://localhost:8080/api/config
   ```

### Этап 2: Исправление (если найдена проблема)

В зависимости от результатов диагностики:

| Проблема | Решение |
|----------|---------|
| Кэш браузера | Hard refresh (Ctrl+Shift+R) |
| Сервер не запущен | `docker-compose up -d` |
| 401 Unauthorized | Перелогиниться или включить Demo режим |
| JavaScript ошибка | Исправить конкретную ошибку |
| Сборка устарела | `npm run build && docker-compose up -d --build` |

### Этап 3: Верификация

1. Очистить кэш браузера
2. Перезагрузить страницу
3. Нажать кнопку "+"
4. Убедиться, что создаётся новая страница "Новая страница"

## Стратегия тестирования

### Ручное тестирование:

1. Открыть приложение в режиме инкогнито
2. Войти через Demo режим (или OAuth)
3. Нажать кнопку "+" рядом с "Страницы"
4. **Ожидаемый результат:** Создаётся "Новая страница" и открывается в редакторе
5. Проверить Console и Network на ошибки

### Автоматические проверки:

```bash
# TypeScript проверка
npx vue-tsc --noEmit

# Запуск сервера для тестирования API
docker-compose up -d

# Тест API создания заметки
curl -X POST http://localhost:8080/api/notes \
  -H "Content-Type: application/json" \
  -H "Cookie: SESSION_ID=<valid_session>" \
  -d '{"title":"Test Note","content":""}'
```

## Оценка рисков

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Код исправлен, но браузер кэширует старую версию | Высокая | Среднее | Hard refresh + очистка кэша |
| Сервер не запущен | Средняя | Высокое | Проверить `docker-compose ps` |
| Проблемы с авторизацией | Средняя | Высокое | Проверить Network tab |
| Реальный баг в коде | Низкая | Критическое | Требуется дополнительный анализ |

## Связанные документы

- `specs/bugs/BUG_DIAGNOSTIC_create_new_note_doesn_t_work.md` — Предыдущий отчёт (ЗАКРЫТ)
- `specs/bugs/BUG_DIAGNOSTIC_create_new_note_not_working.md` — Ранний отчёт

---

**Дата диагностики:** 2026-02-20
**Серьёзность:** HIGH
**Статус:** ТРЕБУЕТ RUNTIME-ДИАГНОСТИКИ

**Заключение:** Код приложения корректен. Проблема, вероятнее всего, связана с runtime-окружением (кэш браузера, состояние сервера, авторизация). Рекомендуется выполнить runtime-диагностику согласно плану выше.
