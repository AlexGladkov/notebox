# Спецификация: Унификация левой панели с папками и средней панели с заметками

## ID задачи
F-1b35fa4e

## Статус
**ОЖИДАЕТ УТОЧНЕНИЯ** - Интервью не завершено, требуется дополнительный ввод пользователя.

---

## Краткое описание

Преобразование текущего трёхпанельного интерфейса (Sidebar + NoteList + NoteEditor) в двухпанельный интерфейс с единым древовидным списком страниц, аналогичным Notion.

---

## Собранные требования

### Подтверждённые требования (из интервью)

1. **Структура навигации**: Единое дерево (как в Notion)
   - Пользователь выбрал: папки, страницы и вложенные страницы в одной иерархии

2. **Удаление концепции папок**: Только страницы
   - Пользователь выбрал: полностью убрать концепцию папок (Folder), оставить только страницы (Note)

### Требования, требующие уточнения

3. **Миграция данных**: НЕ ОПРЕДЕЛЕНО
   - Варианты:
     - Автоматическая миграция (папки → страницы-контейнеры)
     - Ручная миграция (пользователь реорганизует сам)
     - Миграция не нужна (новый проект)
   - **Рекомендация**: Автоматическая миграция с резервным копированием

---

## Текущая архитектура

### Компоненты UI (Vue)
- `App.vue` — главный компонент с трёхпанельной структурой
- `Sidebar.vue` (w-64) — левая панель с папками и поиском
- `NoteList.vue` (w-80) — средняя панель со списком заметок
- `NoteEditor.vue` — правая панель с редактором
- `FolderTree.vue` — дерево папок
- `NoteTree.vue` — дерево заметок (уже поддерживает вложенность)

### Модели данных
```typescript
interface Folder {
  id: string;
  name: string;
  parentId: string | null;
  createdAt: number;
  updatedAt: number;
}

interface Note {
  id: string;
  title: string;
  content: string;
  folderId: string;        // УДАЛИТЬ
  parentId?: string | null; // ОСТАВИТЬ (для иерархии)
  icon?: string | null;
  backdropType?: string | null;
  backdropValue?: string | null;
  backdropPositionY?: number;
  createdAt: number;
  updatedAt: number;
  isBlockFormat?: boolean;
}
```

### Composables
- `useFolders.ts` — работа с папками (УДАЛИТЬ)
- `useNotes.ts` — работа с заметками (МОДИФИЦИРОВАТЬ)
- `useStorage.ts` — хранилище состояния
- `useTabs.ts` — система вкладок

### API
- `src/api/folders.ts` — API для папок (УДАЛИТЬ)
- `src/api/notes.ts` — API для заметок (МОДИФИЦИРОВАТЬ)
- `server/src/main/kotlin/com/notebox/domain/folder/` — серверные контроллеры папок (УДАЛИТЬ)
- `server/src/main/kotlin/com/notebox/domain/note/` — серверные контроллеры заметок (МОДИФИЦИРОВАТЬ)

---

## Предлагаемый подход реализации

### Этап 1: Подготовка (Backend)

1. **Модификация модели Note**
   - Удалить поле `folderId`
   - `parentId` становится основным полем для иерархии
   - Корневые страницы: `parentId = null`

2. **Миграция базы данных**
   - Создать миграцию для преобразования папок в страницы
   - Каждая папка становится страницей с `content = ''`
   - Заметки папки получают `parentId` = ID новой страницы

3. **Обновление API**
   - Удалить endpoints папок
   - Обновить endpoints заметок

### Этап 2: Frontend - Компоненты

1. **Новый компонент UnifiedSidebar.vue**
   - Объединить функционал Sidebar и NoteList
   - Ширина: ~280px (между 256 и 320)
   - Единое дерево страниц
   - Поиск остаётся сверху

2. **Модификация App.vue**
   - Удалить NoteList
   - Заменить Sidebar на UnifiedSidebar
   - Двухпанельный layout: UnifiedSidebar + NoteEditor

3. **Обновление NoteTree.vue**
   - Использовать как основу для нового дерева
   - Добавить drag-and-drop между страницами
   - Сохранить контекстное меню

### Этап 3: Frontend - Логика

1. **Удалить useFolders.ts**

2. **Обновить useNotes.ts**
   - Добавить `getRootPages()` — страницы без родителя
   - Обновить `createNote` — без folderId
   - Добавить `moveNote` — перемещение между родителями

3. **Обновить useStorage.ts**
   - Удалить `folders` из состояния

---

## Файлы для изменения

### Удалить
- `src/components/Sidebar.vue`
- `src/components/FolderTree.vue`
- `src/components/FolderItem.vue`
- `src/composables/useFolders.ts`
- `src/api/folders.ts`
- `server/.../domain/folder/*` (все файлы папки)

### Создать
- `src/components/UnifiedSidebar.vue`
- `src/components/PageTreeItem.vue`
- Миграция БД (если нужна)

### Модифицировать
- `src/App.vue`
- `src/components/NoteTree.vue`
- `src/composables/useNotes.ts`
- `src/composables/useStorage.ts`
- `src/api/notes.ts`
- `src/types/index.ts`
- `server/.../domain/note/*`

---

## Критерии приёмки

1. **Единая левая панель**
   - [ ] Отображает все страницы в древовидной структуре
   - [ ] Поддерживает неограниченную вложенность
   - [ ] Сохраняет состояние сворачивания/разворачивания

2. **Удаление папок**
   - [ ] Концепция папок полностью удалена из UI
   - [ ] API папок удалён
   - [ ] Модель данных обновлена

3. **Функциональность**
   - [ ] Создание корневых страниц
   - [ ] Создание вложенных страниц
   - [ ] Перемещение страниц drag-and-drop
   - [ ] Поиск по всем страницам
   - [ ] Переключатель темы сохранён

4. **Миграция** (если применимо)
   - [ ] Существующие папки преобразованы в страницы
   - [ ] Существующие заметки сохранены как дочерние страницы
   - [ ] Данные не потеряны

---

## Edge Cases и риски

1. **Глубокая вложенность**
   - Риск: переполнение отступов при глубокой вложенности
   - Решение: максимальный визуальный отступ, scroll при необходимости

2. **Циклические ссылки**
   - Риск: страница A → B → A
   - Решение: валидация на сервере при перемещении

3. **Большое количество страниц**
   - Риск: медленная загрузка
   - Решение: ленивая загрузка поддеревьев

4. **Обратная совместимость**
   - Риск: потеря данных при миграции
   - Решение: резервное копирование перед миграцией

---

## Вне области задачи

- Изменение редактора заметок (NoteEditor)
- Система вкладок (TabBar)
- Кастомные базы данных (CustomDatabase)
- Система файлов и вложений

---

## Открытые вопросы

1. **Миграция данных**: Как обрабатывать существующие папки?
   - Ожидается ответ пользователя

2. **Сортировка страниц**: По алфавиту или по дате обновления?
   - По умолчанию: по алфавиту (текущее поведение NoteTree)

3. **Drag-and-drop**: Нужен ли в первой версии?
   - Рекомендация: да, для полноценного UX

---

## Примечания

Спецификация создана с неполными данными из-за таймаута интервью. Требуется уточнение по вопросу миграции данных перед началом реализации.

**Дата создания**: 2026-02-17
